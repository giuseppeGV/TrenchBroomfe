name: CI Builds
on:
  # Run on pushes to tags, the "master" branch, and PR's
  push:
    tags:
      - '**'
    branches:
      - master
  pull_request:
  # Manual trigger added
  workflow_dispatch:
permissions:
  # This grants the GITHUB_TOKEN the necessary permissions for use with nuget.
  packages: write
  # Grant the Release step the necessary permissions to upload a release
  contents: write
jobs:
  ci:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # User requested ONLY Windows
        os: [windows-2022]
        tb-build-type: [release]
        tb-arch: [x64]
    env:
      # Record pull request head commit SHA
      TB_PULL_REQUEST_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
      # Set up environment variables required for caching vcpkg packages using NuGet
      # See https://learn.microsoft.com/en-us/vcpkg/consume/binary-caching-github-packages?pivots=windows-runner
      USERNAME: TrenchBroom
      VCPKG_EXE: ${{ github.workspace }}/vcpkg/vcpkg
      FEED_URL: https://nuget.pkg.github.com/TrenchBroom/index.json
      VCPKG_BINARY_SOURCES: "clear;nuget,https://nuget.pkg.github.com/TrenchBroom/index.json,readwrite"
    steps:
      # See: https://github.com/actions/checkout
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: 'recursive'
      # Install Qt
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.9.*'
      # Windows Steps
      - name: Windows - Bootstrap vcpkg
        shell: pwsh
        run: ${{ github.workspace }}/vcpkg/bootstrap-vcpkg.bat
      - name: Windows - Install dependencies
        run: |
          # Chocolatey was taking 3 minutes to install pandoc; just install it directly
          Invoke-WebRequest 'https://github.com/jgm/pandoc/releases/download/2.11.3.1/pandoc-2.11.3.1-windows-x86_64.zip' -OutFile 'pandoc.zip'
          if ("668A62A8990DEB2753753DF0C8D3F1BE567026FE" -ne (Get-FileHash -Path 'pandoc.zip' -Algorithm SHA1).Hash) { exit }
          7z x pandoc.zip -o'.'
          $tb_pandoc_path = "$(pwd)\pandoc-2.11.3.1"
          # Add this to the system path
          echo "Pandoc path: $tb_pandoc_path"
          # See: https://docs.github.com/en/free-pro-team@latest/actions/reference/workflow-commands-for-github-actions#environment-files
          echo "$tb_pandoc_path" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      - name: Windows - Add NuGet sources
        shell: pwsh
        run: |
          .$(${{ env.VCPKG_EXE }} fetch nuget) `
            sources add `
            -Source "${{ env.FEED_URL }}" `
            -StorePasswordInClearText `
            -Name GitHubPackages `
            -UserName "${{ env.USERNAME }}" `
            -Password "${{ secrets.GITHUB_TOKEN }}"
          .$(${{ env.VCPKG_EXE }} fetch nuget) `
            setapikey "${{ secrets.GITHUB_TOKEN }}" `
            -Source "${{ env.FEED_URL }}"
      - name: Windows - Build
        shell: pwsh
        continue-on-error: true
        run: |
          # Run the build script and continue even if it fails
          $ErrorActionPreference = "Continue"
          
          # Read the CI-windows.bat file and modify it to continue on error
          $batContent = Get-Content "CI-windows.bat" -Raw
          
          # Replace cmake --build commands to add ContinueOnError flag
          $batContent = $batContent -replace '(cmake\s+--build\s+\.\s+--config\s+\w+)(\s+--parallel)?', '$1$2 -- /p:ContinueOnError=ErrorAndContinue /maxcpucount'
          
          # Also handle msbuild commands if they exist
          $batContent = $batContent -replace '(msbuild\s+[^\s]+\s+/p:Configuration=\w+)', '$1 /p:ContinueOnError=ErrorAndContinue /maxcpucount'
          
          # Save the modified batch file
          $batContent | Out-File "CI-windows-modified.bat" -Encoding ASCII
          
          # Run the modified build script
          cmd.exe /c CI-windows-modified.bat
          
          # Force exit code 0 so workflow continues
          exit 0
      - name: Windows - Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ matrix.os }}
          path: |
            cmakebuild/*.zip
            cmakebuild/*.zip.md5
      # Create release
      # Official action upload-release-asset doesn't support uploading files
      # based on a glob, so use https://github.com/softprops/action-gh-release
      - name: Release
        uses: softprops/action-gh-release@v1
        continue-on-error: true
        # Runs on tags, excluding sanitize builds. 
        # (Since the OS is now only windows-2022, we don't strictly need the matrix.os check, but it is safe to keep)
        if: ${{ startsWith(github.ref, 'refs/tags/') && matrix.tb-build-type != 'sanitize' }}
        with:
          draft: true
          files: |
            cmakebuild/*.zip
            cmakebuild/*.zip.md5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}